<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Integración SRI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .card { margin-bottom: 20px; }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .status-AUTORIZADO { background-color: #28a745; color: white; }
        .status-RECIBIDO { background-color: #17a2b8; color: white; }
        .status-FIRMADO { background-color: #6c757d; color: white; }
        .status-RECHAZADO { background-color: #dc3545; color: white; }
        .status-ERROR { background-color: #dc3545; color: white; }
        .status-LEGACY { background-color: #ffc107; color: black; }
        pre { max-height: 300px; overflow-y: auto; }
        .log-DEBUG { color: #6c757d; }
        .log-INFO { color: #17a2b8; }
        .log-WARNING { color: #ffc107; }
        .log-ERROR { color: #dc3545; }
        .log-CRITICAL { color: white; background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Prueba de Integración SRI</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Facturas de Loyverse</h5>
                        <button id="cargarFacturasLoyverse" class="btn btn-sm btn-outline-primary">Cargar Facturas</button>
                    </div>
                    <div class="card-body">
                        <div id="loyverseFacturas" class="mt-3">
                            <div class="alert alert-info">Haga clic en "Cargar Facturas" para ver las facturas de Loyverse</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Certificado Digital</h5>
                    </div>
                    <div class="card-body">
                        <button id="verificarCertificado" class="btn btn-primary">Verificar Certificado</button>
                        <div id="certificadoInfo" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Generar Factura de Prueba</h5>
                    </div>
                    <div class="card-body">
                        <form id="facturaForm">
                            <div class="mb-3">
                                <label for="tipoIdentificacion" class="form-label">Tipo de Identificación</label>
                                <select id="tipoIdentificacion" class="form-select">
                                    <option value="04">RUC</option>
                                    <option value="05">Cédula</option>
                                    <option value="07">Consumidor Final</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="identificacion" class="form-label">Identificación</label>
                                <input type="text" class="form-control" id="identificacion" value="1792060346001">
                            </div>
                            <div class="mb-3">
                                <label for="razonSocial" class="form-label">Razón Social</label>
                                <input type="text" class="form-control" id="razonSocial" value="EMPRESA DE PRUEBA S.A.">
                            </div>
                            <div class="mb-3">
                                <label for="direccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="direccion" value="Av. Amazonas N36-152">
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" value="cliente@ejemplo.com">
                            </div>
                            <div class="mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono" value="022000000">
                            </div>
                            <div class="mb-3">
                                <label for="valorTotal" class="form-label">Valor Total (sin impuestos)</label>
                                <input type="number" class="form-control" id="valorTotal" value="100.00">
                            </div>
                            <button type="submit" class="btn btn-success">Generar y Procesar</button>
                        </form>
                        <div id="facturaResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Comprobantes</h5>
                        <button id="refreshComprobantes" class="btn btn-sm btn-outline-primary">Actualizar</button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <select id="filtroEstado" class="form-select">
                                <option value="">Todos los estados</option>
                                <option value="firmado">FIRMADO</option>
                                <option value="recibido">RECIBIDO</option>
                                <option value="autorizado">AUTORIZADO</option>
                                <option value="rechazado">RECHAZADO</option>
                                <option value="error">ERROR</option>
                            </select>
                        </div>
                        <div id="comprobantesList"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Logs</h5>
                        <div>
                            <select id="filtroTipoLog" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                <option value="all">Todos</option>
                                <option value="errors">Errores</option>
                                <option value="sri">SRI</option>
                            </select>
                            <button id="refreshLogs" class="btn btn-sm btn-outline-primary ms-2">Actualizar</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <pre id="logsContent"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar certificado
            document.getElementById('verificarCertificado').addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/certificado/verificar');
                    const data = await response.json();
                    
                    let html = '<div class="alert ';
                    html += data.success ? 'alert-success' : 'alert-danger';
                    html += '">' + (data.success ? data.mensaje : data.message) + '</div>';
                    
                    if (data.success && data.certificado) {
                        html += '<table class="table table-sm">';
                        html += '<tr><th>Titular</th><td>' + data.certificado.info.nombreTitular + '</td></tr>';
                        html += '<tr><th>RUC</th><td>' + data.certificado.info.rucTitular + '</td></tr>';
                        html += '<tr><th>Entidad</th><td>' + data.certificado.info.issuer + '</td></tr>';
                        html += '<tr><th>Válido Desde</th><td>' + new Date(data.certificado.info.validFrom).toLocaleDateString() + '</td></tr>';
                        html += '<tr><th>Válido Hasta</th><td>' + new Date(data.certificado.info.validTo).toLocaleDateString() + '</td></tr>';
                        
                        // Calcular días restantes
                        const hoy = new Date();
                        const validHasta = new Date(data.certificado.info.validTo);
                        const diasRestantes = Math.ceil((validHasta - hoy) / (1000 * 60 * 60 * 24));
                        
                        html += '<tr><th>Días Restantes</th><td>' + diasRestantes + '</td></tr>';
                        html += '<tr><th>Es Firma Digital</th><td>' + (data.certificado.esFirmaDigital ? 'Sí' : 'No') + '</td></tr>';
                        html += '</table>';
                    }
                    
                    document.getElementById('certificadoInfo').innerHTML = html;
                } catch (error) {
                    document.getElementById('certificadoInfo').innerHTML = 
                        '<div class="alert alert-danger">Error al verificar certificado: ' + error.message + '</div>';
                }
            });
            
            // Generar factura
            document.getElementById('facturaForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const facturaData = {
                    cliente: {
                        tipoIdentificacion: document.getElementById('tipoIdentificacion').value,
                        identificacion: document.getElementById('identificacion').value,
                        razonSocial: document.getElementById('razonSocial').value,
                        direccion: document.getElementById('direccion').value,
                        email: document.getElementById('email').value,
                        telefono: document.getElementById('telefono').value
                    },
                    factura: {
                        // Usar la fecha actual de Ecuador (UTC-5)
                        fechaEmision: new Date().toLocaleString('sv', { timeZone: 'America/Guayaquil' }).split(' ')[0],
                        secuencial: '000000001',
                        formaPago: '01',
                        importeTotal: parseFloat(document.getElementById('valorTotal').value) * 1.12,
                        moneda: 'DOLAR',
                        propina: 0,
                        items: [
                            {
                                codigo: 'PROD-001',
                                descripcion: 'Producto de prueba 1',
                                cantidad: 1,
                                precioUnitario: parseFloat(document.getElementById('valorTotal').value),
                                descuento: 0,
                                precioTotalSinImpuesto: parseFloat(document.getElementById('valorTotal').value),
                                impuestos: [
                                    {
                                        codigo: '2',
                                        codigoPorcentaje: '2',
                                        tarifa: 12,
                                        baseImponible: parseFloat(document.getElementById('valorTotal').value),
                                        valor: parseFloat(document.getElementById('valorTotal').value) * 0.12
                                    }
                                ]
                            }
                        ],
                        totalSinImpuestos: parseFloat(document.getElementById('valorTotal').value),
                        totalDescuento: 0,
                        impuestos: [
                            {
                                codigo: '2',
                                codigoPorcentaje: '2',
                                baseImponible: parseFloat(document.getElementById('valorTotal').value),
                                valor: parseFloat(document.getElementById('valorTotal').value) * 0.12
                            }
                        ]
                    }
                };
                
                try {
                    document.getElementById('facturaResult').innerHTML = 
                        '<div class="alert alert-info">Procesando factura...</div>';
                    
                    const response = await fetch('/api/factura', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(facturaData)
                    });
                    
                    const data = await response.json();
                    
                    let html = '<div class="alert ';
                    html += data.success ? 'alert-success' : 'alert-danger';
                    html += '">' + (data.success ? 'Factura procesada correctamente' : data.message) + '</div>';
                    
                    if (data.success && data.resultado) {
                        html += '<div><strong>Clave de Acceso:</strong> ' + data.resultado.claveAcceso + '</div>';
                        html += '<div><strong>Estado:</strong> ' + data.resultado.estado + '</div>';
                        
                        if (data.resultado.autorizacion) {
                            html += '<div><strong>Número de Autorización:</strong> ' + data.resultado.autorizacion.numeroAutorizacion + '</div>';
                            html += '<div><strong>Fecha de Autorización:</strong> ' + data.resultado.autorizacion.fechaAutorizacion + '</div>';
                        }
                    }
                    
                    document.getElementById('facturaResult').innerHTML = html;
                    
                    // Actualizar lista de comprobantes
                    cargarComprobantes();
                    cargarLogs();
                } catch (error) {
                    document.getElementById('facturaResult').innerHTML = 
                        '<div class="alert alert-danger">Error al procesar factura: ' + error.message + '</div>';
                }
            });
            
            // Cargar comprobantes
            async function cargarComprobantes() {
                try {
                    const estado = document.getElementById('filtroEstado').value;
                    const url = '/api/comprobantes' + (estado ? `?estado=${estado}` : '');
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (!data.success) {
                        document.getElementById('comprobantesList').innerHTML = 
                            '<div class="alert alert-danger">' + data.message + '</div>';
                        return;
                    }
                    
                    if (!data.comprobantes || data.comprobantes.length === 0) {
                        document.getElementById('comprobantesList').innerHTML = 
                            '<div class="alert alert-info">No hay comprobantes disponibles</div>';
                        return;
                    }
                    
                    let html = '';
                    
                    // Mostrar estadísticas
                    if (data.estadisticas) {
                        html += '<div class="mb-3">';
                        for (const [estado, count] of Object.entries(data.estadisticas)) {
                            if (count > 0) {
                                html += `<span class="badge status-${estado} me-2">${estado}: ${count}</span>`;
                            }
                        }
                        html += '</div>';
                    }
                    
                    // Listar comprobantes
                    html += '<div class="list-group">';
                    data.comprobantes.forEach(comprobante => {
                        html += `<div class="list-group-item">`;
                        html += `<div class="d-flex justify-content-between align-items-center">`;
                        html += `<h6 class="mb-1">${comprobante.claveAcceso.substring(0, 10)}...${comprobante.claveAcceso.substring(40)}</h6>`;
                        html += `<span class="badge status-${comprobante.estado}">${comprobante.estado}</span>`;
                        html += `</div>`;
                        html += `<p class="mb-1">Fecha: ${new Date(comprobante.fecha).toLocaleString()}</p>`;
                        html += `<div class="btn-group btn-group-sm">`;
                        html += `<button class="btn btn-outline-primary btn-verificar" data-clave="${comprobante.claveAcceso}">Verificar</button>`;
                        html += `<a href="/api/comprobantes/download/${comprobante.claveAcceso}" class="btn btn-outline-secondary" target="_blank">Descargar XML</a>`;
                        html += `</div>`;
                        html += `</div>`;
                    });
                    html += '</div>';
                    
                    document.getElementById('comprobantesList').innerHTML = html;
                    
                    // Agregar event listeners a los botones de verificar
                    document.querySelectorAll('.btn-verificar').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const claveAcceso = this.getAttribute('data-clave');
                            try {
                                const response = await fetch(`/api/comprobante/${claveAcceso}`);
                                const data = await response.json();
                                
                                alert(JSON.stringify(data, null, 2));
                            } catch (error) {
                                alert('Error al verificar comprobante: ' + error.message);
                            }
                        });
                    });
                } catch (error) {
                    document.getElementById('comprobantesList').innerHTML = 
                        '<div class="alert alert-danger">Error al cargar comprobantes: ' + error.message + '</div>';
                }
            }
            
            // Cargar logs
            async function cargarLogs() {
                try {
                    const tipo = document.getElementById('filtroTipoLog').value;
                    const response = await fetch(`/api/logs?tipo=${tipo}`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        document.getElementById('logsContent').innerHTML = data.message;
                        return;
                    }
                    
                    // Formatear logs con colores según nivel
                    let formattedLogs = '';
                    const lines = data.logs.split('\n');
                    lines.forEach(line => {
                        let cssClass = '';
                        if (line.includes('[DEBUG]')) cssClass = 'log-DEBUG';
                        else if (line.includes('[INFO]')) cssClass = 'log-INFO';
                        else if (line.includes('[WARNING]')) cssClass = 'log-WARNING';
                        else if (line.includes('[ERROR]')) cssClass = 'log-ERROR';
                        else if (line.includes('[CRITICAL]')) cssClass = 'log-CRITICAL';
                        
                        formattedLogs += `<div class="${cssClass}">${line}</div>`;
                    });
                    
                    document.getElementById('logsContent').innerHTML = formattedLogs;
                } catch (error) {
                    document.getElementById('logsContent').innerHTML = 'Error al cargar logs: ' + error.message;
                }
            }
            
            // Event listeners para filtros y botones de actualización
            document.getElementById('filtroEstado').addEventListener('change', cargarComprobantes);
            document.getElementById('refreshComprobantes').addEventListener('click', cargarComprobantes);
            
            document.getElementById('filtroTipoLog').addEventListener('change', cargarLogs);
            document.getElementById('refreshLogs').addEventListener('click', cargarLogs);
            
            // Cargar facturas de Loyverse
            document.getElementById('cargarFacturasLoyverse').addEventListener('click', async function() {
                try {
                    document.getElementById('loyverseFacturas').innerHTML = 
                        '<div class="alert alert-info">Cargando facturas de Loyverse...</div>';
                    
                    const response = await fetch('/api/loyverse/facturas');
                    const data = await response.json();
                    
                    if (!data.receipts || data.receipts.length === 0) {
                        document.getElementById('loyverseFacturas').innerHTML = 
                            '<div class="alert alert-warning">No se encontraron facturas en Loyverse</div>';
                        return;
                    }
                    
                    let html = `<div class="mb-3">Se encontraron ${data.receipts.length} facturas</div>`;
                    html += '<div class="accordion" id="accordionLoyverse">';
                    
                    data.receipts.forEach((receipt, index) => {
                        const receiptId = receipt.receipt_number || `receipt-${index}`;
                        const customer = receipt.customer || {};
                        const total = receipt.total_money || 0;
                        const date = new Date(receipt.receipt_date || receipt.created_at).toLocaleString();
                        
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#collapse-${receiptId}" aria-expanded="false">
                                        <div class="d-flex justify-content-between w-100">
                                            <span><strong>${receiptId}</strong> - ${date}</span>
                                            <span class="ms-3">$${total.toFixed(2)}</span>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse-${receiptId}" class="accordion-collapse collapse" data-bs-parent="#accordionLoyverse">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <h6>Cliente</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Nombre:</strong> ${customer.name || 'No especificado'}</li>
                                                <li><strong>Código:</strong> ${customer.customer_code || 'No especificado'}</li>
                                                <li><strong>Email:</strong> ${customer.email || 'No especificado'}</li>
                                                <li><strong>Teléfono:</strong> ${customer.phone_number || 'No especificado'}</li>
                                            </ul>
                                        </div>
                                        <div class="mb-3">
                                            <h6>Detalles</h6>
                                            <ul class="list-unstyled">
                                                <li><strong>Subtotal:</strong> $${(receipt.total_money - receipt.total_tax).toFixed(2)}</li>
                                                <li><strong>Impuestos:</strong> $${(receipt.total_tax || 0).toFixed(2)}</li>
                                                <li><strong>Total:</strong> $${total.toFixed(2)}</li>
                                            </ul>
                                        </div>
                                        <div>
                                            <h6>Productos</h6>
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Producto</th>
                                                        <th>Cantidad</th>
                                                        <th>Precio</th>
                                                        <th>Total</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${(receipt.line_items || []).map(item => `
                                                        <tr>
                                                            <td>${item.item_name}</td>
                                                            <td>${item.quantity}</td>
                                                            <td>$${item.price.toFixed(2)}</td>
                                                            <td>$${item.total_money.toFixed(2)}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-sm btn-primary btn-procesar-loyverse" 
                                                    data-receipt-id="${receipt.id}">Procesar en SRI</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    
                    document.getElementById('loyverseFacturas').innerHTML = html;
                    
                    // Agregar event listeners a los botones de procesar
                    document.querySelectorAll('.btn-procesar-loyverse').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const receiptId = this.getAttribute('data-receipt-id');
                            const receipt = data.receipts.find(r => r.id === receiptId);
                            
                            if (!receipt) {
                                alert('Error: No se encontró la factura seleccionada');
                                return;
                            }
                            
                            if (confirm(`¿Desea procesar la factura ${receipt.receipt_number} en el SRI?`)) {
                                try {
                                    const response = await fetch('/api/loyverse/procesar', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ receipt_id: receipt.id })
                                    });
                                    
                                    const result = await response.json();
                                    
                                    if (result.success) {
                                        alert(`Factura procesada correctamente. Clave de acceso: ${result.claveAcceso}`);
                                        cargarComprobantes();
                                    } else {
                                        alert(`Error al procesar factura: ${result.message}`);
                                    }
                                } catch (error) {
                                    alert(`Error al procesar factura: ${error.message}`);
                                }
                            }
                        });
                    });
                    
                } catch (error) {
                    document.getElementById('loyverseFacturas').innerHTML = 
                        `<div class="alert alert-danger">Error al cargar facturas de Loyverse: ${error.message}</div>`;
                }
            });
            
            // Cargar datos iniciales
            cargarComprobantes();
            cargarLogs();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
